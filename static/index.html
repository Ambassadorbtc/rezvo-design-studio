<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rezvo Design Studio</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg-base: #0f0f17;
    --bg-surface: #1a1a2e;
    --bg-elevated: #222236;
    --border: #2a2a40;
    --border-focus: #6c5ce7;
    --text-primary: #e2e2f0;
    --text-secondary: #8888a8;
    --text-muted: #555570;
    --accent: #6c5ce7;
    --accent-hover: #7c6ef7;
    --accent-dim: rgba(108,92,231,0.15);
    --danger: #f38ba8;
    --success: #a6e3a1;
    --font: 'DM Sans', -apple-system, sans-serif;
    --mono: 'JetBrains Mono', monospace;
  }
  body { font-family: var(--font); background: var(--bg-base); color: var(--text-primary); height: 100vh; overflow: hidden; }
  input, textarea, button, select { font-family: var(--font); }
  button { cursor: pointer; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  #app { display: flex; flex-direction: column; height: 100vh; }
  #topbar { height: 52px; background: var(--bg-surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 100; }
  #topbar .logo { font-size: 17px; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; }
  #topbar .logo span { font-weight: 400; color: var(--text-muted); font-size: 13px; margin-left: 6px; }
  #topbar .breadcrumb { color: var(--text-muted); font-size: 13px; margin-left: 8px; }
  #topbar .breadcrumb::before { content: '/'; margin-right: 8px; color: var(--border); }
  #topbar .actions { display: flex; align-items: center; gap: 10px; }
  .btn { padding: 7px 16px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); font-size: 13px; transition: all 0.15s; }
  .btn:hover { border-color: var(--accent); color: var(--text-primary); }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 600; }
  .btn-primary:hover { background: var(--accent-hover); }
  .provider-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }

  #main { flex: 1; overflow: hidden; }

  /* Dashboard */
  #dashboard { padding: 40px 48px; max-width: 1200px; margin: 0 auto; overflow-y: auto; height: 100%; }
  #dashboard h1 { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
  #dashboard .subtitle { color: var(--text-secondary); font-size: 15px; margin-bottom: 32px; }
  .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 14px; }
  .project-card { padding: 20px; border-radius: 14px; border: 1px solid var(--border); background: var(--bg-surface); text-align: left; transition: all 0.2s; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between; }
  .project-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .project-card .name { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .project-card .meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  .project-card .date { font-size: 12px; color: var(--text-muted); margin-top: 12px; }
  .new-card { border: 2px dashed var(--border); background: transparent; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 14px; }
  .new-card:hover { border-color: var(--accent); color: var(--accent); }
  .new-card .plus { font-size: 28px; }

  /* Studio */
  #studio { display: flex; height: 100%; }
  #chat-panel { width: 360px; background: var(--bg-surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
  #chat-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
  #chat-header .back { background: none; border: none; color: var(--text-muted); font-size: 20px; padding: 4px; }
  #chat-header .back:hover { color: var(--text-primary); }
  #device-toggle { padding: 10px 18px; border-bottom: 1px solid var(--border); display: flex; gap: 4px; }
  #device-toggle button { flex: 1; padding: 6px; border-radius: 8px; border: none; font-size: 12px; background: transparent; color: var(--text-muted); transition: all 0.15s; }
  #device-toggle button.active { background: var(--accent); color: #fff; font-weight: 600; }

  /* Provider selector in chat */
  #provider-bar { padding: 8px 18px; border-bottom: 1px solid var(--border); display: flex; gap: 4px; }
  #provider-bar button { padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 11px; font-weight: 600; background: transparent; color: var(--text-muted); transition: all 0.15s; display: flex; align-items: center; gap: 4px; }
  #provider-bar button.active { border-color: var(--accent); color: var(--text-primary); background: var(--accent-dim); }
  #provider-bar button .dot { width: 6px; height: 6px; border-radius: 50%; }

  #chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
  .msg { max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-break: break-word; }
  .msg.user { align-self: flex-end; background: var(--accent); color: #fff; }
  .msg.assistant { align-self: flex-start; background: var(--bg-elevated); color: var(--text-primary); }
  .msg img { max-width: 200px; border-radius: 8px; margin-bottom: 6px; display: block; }
  .empty-chat { text-align: center; padding: 40px 20px; color: var(--text-muted); }
  .empty-chat .icon { font-size: 40px; margin-bottom: 10px; }
  #upload-preview { padding: 8px 16px; border-top: 1px solid var(--border); position: relative; }
  #upload-preview img { height: 56px; border-radius: 8px; border: 1px solid var(--border); }
  #upload-preview .remove { position: absolute; top: 2px; left: 70px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); border: none; color: #fff; font-size: 11px; display: flex; align-items: center; justify-content: center; }
  #chat-input { padding: 14px 16px; border-top: 1px solid var(--border); }
  #chat-input .row { display: flex; gap: 8px; align-items: flex-end; }
  #chat-input .attach { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); font-size: 18px; flex-shrink: 0; }
  #chat-input .attach:hover { border-color: var(--accent); color: var(--accent); }
  #chat-input textarea { flex: 1; padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-base); color: var(--text-primary); font-size: 13px; resize: none; outline: none; line-height: 1.4; min-height: 40px; max-height: 100px; }
  #chat-input textarea:focus { border-color: var(--accent); }
  #chat-input .send { width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--accent); color: #fff; font-size: 16px; flex-shrink: 0; }
  #chat-input .send:disabled { background: var(--border); cursor: default; }
  .generating-indicator { display: flex; align-items: center; gap: 8px; color: var(--accent); font-size: 13px; }
  .pulse-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* Canvas */
  #canvas-area { flex: 1; position: relative; overflow: hidden; }
  #canvas { width: 100%; height: 100%; cursor: default; }
  #canvas.moving { cursor: grab; }
  #canvas.panning { cursor: grabbing; }
  #canvas-inner { transform-origin: 0 0; position: absolute; top: 0; left: 0; }
  .screen-frame { position: absolute; cursor: pointer; }
  .screen-frame .label { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 6px; }
  .screen-frame .label .prov { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
  .screen-frame .frame { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .screen-frame.selected .frame { border: 3px solid var(--accent); box-shadow: 0 0 30px rgba(108,92,231,0.3); }
  .screen-frame iframe { border: none; pointer-events: none; display: block; }

  .wireframe-placeholder { position: absolute; }
  .wireframe-placeholder .label { font-size: 12px; color: var(--accent); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
  .wireframe-box { border: 2px dashed var(--accent); border-radius: 12px; padding: 2px; box-shadow: 0 0 40px rgba(108,92,231,0.15); }
  .progress-bar { margin-top: 8px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-bar .fill { height: 100%; background: linear-gradient(90deg, #6c5ce7, #a29bfe); border-radius: 2px; transition: width 0.3s; }
  .empty-canvas { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); text-align: center; color: var(--text-muted); }
  .empty-canvas .icon { font-size: 60px; margin-bottom: 14px; opacity: 0.5; }
  .empty-canvas .title { font-size: 18px; font-weight: 600; margin-bottom: 6px; }

  #canvas-toolbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 2px; padding: 6px 8px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 10; }
  #canvas-toolbar button { padding: 7px 14px; border-radius: 8px; border: none; font-size: 13px; background: transparent; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
  #canvas-toolbar button.active { background: var(--accent); color: #fff; font-weight: 600; }
  #canvas-toolbar button:hover:not(.active) { color: var(--text-primary); }
  #canvas-toolbar .sep { width: 1px; height: 24px; background: var(--border); margin: 0 6px; }
  #canvas-toolbar .zoom-val { font-size: 12px; color: var(--text-muted); min-width: 42px; text-align: center; font-family: var(--mono); }
  #canvas-toolbar .zoom-btn { width: 30px; height: 30px; padding: 0; justify-content: center; font-size: 16px; }

  #canvas-actions { position: absolute; top: 14px; right: 18px; display: flex; gap: 8px; align-items: center; z-index: 10; }
  #canvas-actions .count { font-size: 12px; color: var(--text-muted); }

  /* Modals */
  .modal-overlay { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
  .modal { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; color: var(--text-primary); }
  .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
  .modal label { font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 8px; }
  .modal input[type="text"], .modal input[type="password"] { width: 100%; padding: 11px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-base); color: var(--text-primary); font-size: 14px; outline: none; }
  .modal input:focus { border-color: var(--accent); }
  .modal .hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
  .modal .btns { display: flex; gap: 10px; margin-top: 22px; }
  .modal .btns button { flex: 1; padding: 11px 20px; border-radius: 10px; font-size: 14px; }
  .device-options { display: flex; gap: 10px; margin-bottom: 20px; }
  .device-option { flex: 1; padding: 14px 10px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-base); color: var(--text-muted); text-align: center; transition: all 0.15s; }
  .device-option.active { border: 2px solid var(--accent); background: var(--accent-dim); color: var(--text-primary); }
  .device-option .icon { font-size: 26px; margin-bottom: 4px; }
  .device-option .label { font-size: 13px; font-weight: 600; }
  .device-option .size { font-size: 11px; opacity: 0.6; }

  /* Provider key rows in settings */
  .key-row { margin-bottom: 16px; }
  .key-row .key-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .key-row .key-header .dot { width: 8px; height: 8px; border-radius: 50%; }
  .key-row .key-header label { margin-bottom: 0; font-weight: 600; }

  #canvas { background-image: radial-gradient(circle, #1a1a2e 1px, transparent 1px); background-size: 20px 20px; }
</style>
</head>
<body>

<div id="app">
  <div id="topbar">
    <div style="display:flex;align-items:center;">
      <div class="logo">REZVO<span>STUDIO</span></div>
      <div class="breadcrumb" id="breadcrumb" style="display:none;"></div>
    </div>
    <div class="actions">
      <span class="provider-badge" id="activeProviderBadge"></span>
      <button class="btn" onclick="showSettings()">‚öô Settings</button>
    </div>
  </div>

  <div id="main">
    <div id="dashboard">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:36px;">
        <div>
          <h1>Start generating your designs</h1>
          <p class="subtitle">Upload screenshots, describe what you want, get pixel-accurate code.</p>
        </div>
        <button class="btn btn-primary" onclick="showNewProject()" style="font-size:14px;padding:10px 22px;">+ New Project</button>
      </div>
      <div style="font-size:14px;color:var(--text-muted);margin-bottom:16px;">Projects</div>
      <div class="project-grid" id="projectGrid"></div>
    </div>

    <div id="studio" style="display:none;">
      <div id="chat-panel">
        <div id="chat-header">
          <button class="back" onclick="goToDashboard()">‚Üê</button>
          <div>
            <div id="chatProjectName" style="font-size:15px;font-weight:600;"></div>
            <div id="chatScreenCount" style="font-size:11px;color:var(--text-muted);"></div>
          </div>
        </div>
        <div id="provider-bar"></div>
        <div id="device-toggle"></div>
        <div id="chat-messages"></div>
        <div id="upload-preview" style="display:none;">
          <img id="uploadThumb" src="">
          <button class="remove" onclick="clearUpload()">‚úï</button>
        </div>
        <div id="chat-input">
          <div class="row">
            <button class="attach" onclick="document.getElementById('fileInput').click()">üìé</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(event)">
            <textarea id="promptInput" placeholder="'copy this' or describe changes..." rows="2" onkeydown="handlePromptKey(event)"></textarea>
            <button class="send" id="sendBtn" onclick="handleGenerate()" disabled>‚Üí</button>
          </div>
        </div>
      </div>

      <div id="canvas-area">
        <div id="canvas" onmousedown="canvasMouseDown(event)" onmousemove="canvasMouseMove(event)" onmouseup="canvasMouseUp()" onmouseleave="canvasMouseUp()" onwheel="canvasWheel(event)">
          <div id="canvas-inner"></div>
        </div>
        <div id="canvas-toolbar">
          <button id="toolSelect" class="active" onclick="setTool('select')">‚¨Ü Select</button>
          <button id="toolMove" onclick="setTool('move')">‚úã Move</button>
          <div class="sep"></div>
          <button class="zoom-btn" onclick="zoomBy(-0.1)">‚àí</button>
          <span class="zoom-val" id="zoomVal">50%</span>
          <button class="zoom-btn" onclick="zoomBy(0.1)">+</button>
          <div class="sep"></div>
          <button onclick="resetView()" style="font-size:12px;">Reset</button>
        </div>
        <div id="canvas-actions">
          <span class="count" id="screenCountBadge"></span>
          <button class="btn" id="previewBtn" style="display:none;font-size:12px;" onclick="previewSelected()">‚Üó Preview</button>
          <div style="position:relative;display:inline-block;" id="exportWrap" style="display:none;">
            <button class="btn btn-primary" id="exportBtn" style="display:none;font-size:12px;" onclick="toggleExportMenu()">‚Üì Export ‚ñæ</button>
            <div id="exportMenu" style="display:none;position:absolute;right:0;top:36px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:6px;min-width:180px;z-index:999;box-shadow:0 12px 30px rgba(0,0,0,0.4);">
              <button onclick="exportAs('html')" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;color:var(--text);font-size:13px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='none'">üìÑ HTML File</button>
              <button onclick="exportAs('svg')" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;color:var(--text);font-size:13px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='none'">üé® SVG for Figma</button>
              <button onclick="exportAs('png')" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;color:var(--text);font-size:13px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='none'">üñºÔ∏è PNG Image</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal-overlay" id="newProjectModal" style="display:none;" onclick="if(event.target===this)closeNewProject()">
  <div class="modal" style="width:500px;">
    <h2>New Project</h2>
    <label>Project Name</label>
    <input type="text" id="newProjectName" placeholder="e.g. Square POS Clone" autofocus>
    <label style="margin-top:18px;">Device Target</label>
    <div class="device-options" id="deviceOptions"></div>
    <div class="btns">
      <button class="btn" onclick="closeNewProject()">Cancel</button>
      <button class="btn btn-primary" onclick="createProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal" style="display:none;" onclick="if(event.target===this)closeSettings()">
  <div class="modal" style="width:520px;max-height:85vh;overflow-y:auto;">
    <h2>API Keys</h2>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:20px;">Add keys for the providers you want to use. Keys are stored in your browser only.</p>

    <div class="key-row">
      <div class="key-header"><div class="dot" style="background:#c084fc;"></div><label>Anthropic (Claude)</label></div>
      <input type="password" id="keyAnthropic" placeholder="sk-ant-...">
    </div>
    <div class="key-row">
      <div class="key-header"><div class="dot" style="background:#60a5fa;"></div><label>xAI (Grok)</label></div>
      <input type="password" id="keyXai" placeholder="xai-...">
    </div>
    <div class="key-row">
      <div class="key-header"><div class="dot" style="background:#fbbf24;"></div><label>Google Gemini</label></div>
      <div style="font-size:11px;color:var(--accent);margin-bottom:6px;">‚ö° Also used for image detection ‚Äî add this key to extract real photos from screenshots</div>
      <input type="password" id="keyGemini" placeholder="AIza...">
    </div>
    <div class="key-row">
      <div class="key-header"><div class="dot" style="background:#34d399;"></div><label>OpenAI (GPT-4o)</label></div>
      <input type="password" id="keyOpenai" placeholder="sk-...">
    </div>

    <div class="btns">
      <button class="btn" onclick="closeSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save All</button>
    </div>
  </div>
</div>

<script>
const DEVICES = {
  mobile:  { w: 390, h: 844, label: 'Mobile',  icon: 'üì±' },
  tablet:  { w: 1024, h: 768, label: 'Tablet',  icon: 'üìü' },
  desktop: { w: 1440, h: 900, label: 'Desktop', icon: 'üñ•Ô∏è' },
};

const PROVIDER_META = {
  anthropic: { label: 'Claude', color: '#c084fc', prefix: 'sk-ant-' },
  xai:       { label: 'Grok',   color: '#60a5fa', prefix: 'xai-' },
  gemini:    { label: 'Gemini', color: '#fbbf24', prefix: 'AIza' },
  openai:    { label: 'GPT-4o', color: '#34d399', prefix: 'sk-' },
};

let state = {
  view: 'dashboard',
  projects: [],
  activeProject: null,
  keys: { anthropic: '', xai: '', gemini: '', openai: '' },
  activeProvider: 'anthropic',
  tool: 'select',
  zoom: 0.4,
  pan: { x: 60, y: 60 },
  isPanning: false,
  panStart: { x: 0, y: 0 },
  selectedScreen: null,
  device: 'tablet',
  generating: false,
  progress: 0,
  chatMessages: [],
  uploadData: null,
};

document.addEventListener('DOMContentLoaded', () => {
  // Keys stay in localStorage (tiny)
  try { state.keys = JSON.parse(localStorage.getItem('rezvo_keys') || '{}'); } catch(e) {}
  state.keys = { anthropic: '', xai: '', gemini: '', openai: '', ...state.keys };
  state.activeProvider = localStorage.getItem('rezvo_provider') || 'anthropic';
  if (!state.keys[state.activeProvider]) {
    const avail = Object.keys(state.keys).find(k => state.keys[k]);
    if (avail) state.activeProvider = avail;
  }
  updateProviderBadge();
  renderDashboard();
  updateSendBtn();
  document.getElementById('promptInput')?.addEventListener('input', updateSendBtn);
  
  // Load projects from IndexedDB (handles large base64 scans)
  openProjectsDB().then(async () => {
    const saved = await loadProjectsDB();
    if (saved.length > 0) {
      state.projects = saved;
    } else {
      // Migrate from localStorage if any
      try {
        const old = JSON.parse(localStorage.getItem('rezvo_projects') || '[]');
        if (old.length > 0) { state.projects = old; await saveProjectsDB(); localStorage.removeItem('rezvo_projects'); }
      } catch(e) {}
    }
    if (state.projects.length > 0) { state.activeProject = 0; }
    renderDashboard();
  });
});

// ‚ïê‚ïê‚ïê IndexedDB ‚Äî handles multi-MB scanned HTML that localStorage can't ‚ïê‚ïê‚ïê
let _projDB = null;
function openProjectsDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('rezvo_studio', 1);
    req.onupgradeneeded = (e) => { e.target.result.createObjectStore('projects', { keyPath: '_idx' }); };
    req.onsuccess = (e) => { _projDB = e.target.result; resolve(); };
    req.onerror = (e) => reject(e);
  });
}
function loadProjectsDB() {
  return new Promise((resolve) => {
    try {
      const tx = _projDB.transaction('projects', 'readonly');
      const req = tx.objectStore('projects').get('all');
      req.onsuccess = () => resolve(req.result?.data || []);
      req.onerror = () => resolve([]);
    } catch(e) { resolve([]); }
  });
}
function saveProjectsDB() {
  return new Promise((resolve) => {
    try {
      const tx = _projDB.transaction('projects', 'readwrite');
      tx.objectStore('projects').put({ _idx: 'all', data: state.projects });
      tx.oncomplete = () => resolve();
      tx.onerror = () => resolve();
    } catch(e) { resolve(); }
  });
}

function persist() { saveProjectsDB(); }
function persistKeys() { localStorage.setItem('rezvo_keys', JSON.stringify(state.keys)); localStorage.setItem('rezvo_provider', state.activeProvider); }

function updateProviderBadge() {
  const el = document.getElementById('activeProviderBadge');
  const p = PROVIDER_META[state.activeProvider];
  const hasKey = !!state.keys[state.activeProvider];
  el.style.background = hasKey ? p.color + '22' : 'var(--danger)22';
  el.style.color = hasKey ? p.color : 'var(--danger)';
  el.textContent = hasKey ? p.label : 'No key set';
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
function renderDashboard() {
  const grid = document.getElementById('projectGrid');
  let html = `<button class="project-card new-card" onclick="showNewProject()"><span class="plus">+</span><span>New Project</span></button>`;
  state.projects.forEach((p, i) => {
    const dev = DEVICES[p.device] || DEVICES.tablet;
    const date = new Date(p.createdAt).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
    html += `<button class="project-card" onclick="openProject(${i})">
      <div><div class="name">${dev.icon} ${esc(p.name)}</div><div class="meta">${p.screens.length} screen${p.screens.length!==1?'s':''}</div></div>
      <div class="date">${date}</div>
    </button>`;
  });
  grid.innerHTML = html;
}

function openProject(idx) {
  state.activeProject = idx;
  state.selectedScreen = null;
  state.chatMessages = [];
  state.device = state.projects[idx].device || 'tablet';
  state.zoom = 0.4;
  state.pan = { x: 60, y: 60 };
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('studio').style.display = 'flex';
  document.getElementById('breadcrumb').style.display = '';
  document.getElementById('breadcrumb').textContent = state.projects[idx].name;
  state.view = 'studio';
  renderChatHeader(); renderProviderBar(); renderDeviceToggle(); renderChatMessages(); renderCanvas(); updateCanvasActions();
}

function goToDashboard() {
  document.getElementById('studio').style.display = 'none';
  document.getElementById('dashboard').style.display = '';
  document.getElementById('breadcrumb').style.display = 'none';
  state.view = 'dashboard'; state.activeProject = null;
  renderDashboard();
}

// ‚îÄ‚îÄ Chat ‚îÄ‚îÄ
function renderChatHeader() {
  const p = state.projects[state.activeProject];
  document.getElementById('chatProjectName').textContent = p.name;
  document.getElementById('chatScreenCount').textContent = `${p.screens.length} screens`;
}

function renderProviderBar() {
  const el = document.getElementById('provider-bar');
  el.innerHTML = Object.entries(PROVIDER_META).map(([k, v]) => {
    const hasKey = !!state.keys[k];
    return `<button class="${state.activeProvider===k?'active':''}" onclick="setProvider('${k}')" ${!hasKey?'title="No key set"':''}>
      <span class="dot" style="background:${hasKey ? v.color : 'var(--text-muted)'};"></span>${v.label}
    </button>`;
  }).join('');
}

function setProvider(p) {
  if (!state.keys[p]) { alert(`Add your ${PROVIDER_META[p].label} API key in Settings first.`); showSettings(); return; }
  state.activeProvider = p;
  persistKeys(); renderProviderBar(); updateProviderBadge();
}

function renderDeviceToggle() {
  document.getElementById('device-toggle').innerHTML = Object.entries(DEVICES).map(([k, v]) =>
    `<button class="${state.device===k?'active':''}" onclick="setDevice('${k}')">${v.icon} ${v.label}</button>`
  ).join('');
}
function setDevice(d) { state.device = d; renderDeviceToggle(); }

function renderChatMessages() {
  const el = document.getElementById('chat-messages');
  if (state.chatMessages.length === 0) {
    el.innerHTML = `<div class="empty-chat"><div class="icon">üì∏</div><div style="font-size:15px;font-weight:600;margin-bottom:4px;">Scanner Mode</div><div>Upload a screenshot and type "copy this"<br>to extract pixel-perfect HTML</div></div>`;
    return;
  }
  let html = '';
  state.chatMessages.forEach(m => {
    html += `<div class="msg ${m.role}">`;
    if (m.image) html += `<img src="${m.image}">`;
    html += esc(m.content) + '</div>';
  });
  if (state.generating) {
    const p = PROVIDER_META[state.activeProvider];
    html += `<div class="generating-indicator"><div class="pulse-dot" style="background:${p.color}"></div> ${p.label} generating... ${Math.round(state.progress)}%</div>`;
  }
  el.innerHTML = html;
  el.scrollTop = el.scrollHeight;
}

function addChatMessage(role, content, image) {
  state.chatMessages.push({ role, content, image: image || null });
  renderChatMessages();
}

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ
async function handleFileUpload(event) {
  const file = event.target.files[0]; if (!file) return;
  const formData = new FormData(); formData.append('file', file);
  try {
    const resp = await fetch('/api/upload', { method: 'POST', body: formData });
    const data = await resp.json();
    state.uploadData = { dataUrl: data.data_url, base64: data.base64, mediaType: data.media_type, publicUrl: data.public_url || '' };
    document.getElementById('uploadThumb').src = data.data_url;
    document.getElementById('upload-preview').style.display = '';
    updateSendBtn();
  } catch(e) { alert('Upload failed: ' + e.message); }
  event.target.value = '';
}

function clearUpload() {
  state.uploadData = null;
  document.getElementById('upload-preview').style.display = 'none';
  document.getElementById('uploadThumb').src = '';
  updateSendBtn();
}

function updateSendBtn() {
  const prompt = document.getElementById('promptInput')?.value?.trim();
  document.getElementById('sendBtn').disabled = !(prompt || state.uploadData) || state.generating;
}

function handlePromptKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleGenerate(); } }

// ‚îÄ‚îÄ Generate ‚îÄ‚îÄ
async function handleGenerate() {
  const key = state.keys[state.activeProvider];
  if (!key) { alert(`Set your ${PROVIDER_META[state.activeProvider].label} API key in Settings first.`); return; }
  const prompt = document.getElementById('promptInput').value.trim();
  if (!prompt && !state.uploadData) return;

  addChatMessage('user', prompt || 'Replicate this design', state.uploadData?.dataUrl);
  state.generating = true; state.progress = 0;
  document.getElementById('promptInput').value = '';
  updateSendBtn();
  centerOnPlaceholder();
  renderCanvas(); renderChatMessages();

  const progressTimer = setInterval(() => {
    state.progress = Math.min(state.progress + Math.random() * 4, 92);
    const step = state.progress < 20 ? 'üîç Detecting images...' : state.progress < 40 ? '‚úÇÔ∏è Extracting pixels...' : 'üé® Generating HTML...';
    renderChatMessages();
    const progFill = document.querySelector('.wireframe-placeholder .progress-bar .fill');
    const progLabel = document.querySelector('.wireframe-placeholder .label');
    if (progFill) progFill.style.width = state.progress + '%';
    if (progLabel) {
      const prov = PROVIDER_META[state.activeProvider];
      progLabel.innerHTML = `<div class="pulse-dot" style="background:${prov.color}"></div> ${step} ${Math.round(state.progress)}%`;
    }
  }, 600);

  try {
    const formData = new FormData();
    formData.append('api_key', key);
    formData.append('provider', state.activeProvider);
    formData.append('prompt', prompt);
    formData.append('device', state.device);
    if (state.uploadData) {
      formData.append('image_base64', state.uploadData.base64);
      formData.append('image_media_type', state.uploadData.mediaType);
      formData.append('image_url', state.uploadData.publicUrl || '');
      // Pass Gemini key for image detection (always, regardless of main provider)
      if (state.keys.gemini) formData.append('gemini_key', state.keys.gemini);
    }
    const resp = await fetch('/api/generate', { method: 'POST', body: formData });
    clearInterval(progressTimer); state.progress = 100;
    if (!resp.ok) {
      let errMsg = 'Generation failed';
      try { const err = await resp.json(); errMsg = err.detail || errMsg; } catch(e) { errMsg = `Server error (${resp.status}): ${await resp.text().then(t => t.slice(0, 200)).catch(() => 'Unknown')}`; }
      throw new Error(errMsg);
    }
    let data;
    try { data = await resp.json(); } catch(e) { throw new Error('Invalid response from server ‚Äî not JSON'); }
    const project = state.projects[state.activeProject];
    const pMeta = PROVIDER_META[state.activeProvider];
    project.screens.push({
      id: Date.now(), name: prompt.slice(0, 50) || 'Generated Screen', html: data.html,
      device: state.device, provider: state.activeProvider, createdAt: new Date().toISOString(),
    });
    persist();
    state.selectedScreen = project.screens.length - 1;
    const dev = DEVICES[state.device];
    const imgCount = data.images_detected || 0;
    const method = data.detection_method || '';
    let detectionNote;
    if (method === 'true-scanner') {
      detectionNote = ` ¬∑ üì∏ True Scanner ¬∑ ${imgCount} interactive elements mapped`;
    } else if (imgCount > 0) {
      detectionNote = ` ¬∑ üì∏ ${imgCount} images extracted`;
    } else if (data.detection_used) {
      detectionNote = ' ¬∑ No photos detected';
    } else {
      detectionNote = ' ¬∑ Add Gemini key for image extraction';
    }
    const provLabel = data.provider === 'scanner' ? 'Scanner' : pMeta.label;
    addChatMessage('assistant', `‚úÖ Scanned via ${provLabel} ‚Äî ${dev.label} (${dev.w}√ó${dev.h})${detectionNote}`);
  } catch(e) {
    clearInterval(progressTimer);
    addChatMessage('assistant', `‚ùå Error: ${e.message}`);
  }
  state.generating = false; state.progress = 0; clearUpload();
  renderChatHeader(); renderCanvas(); renderChatMessages(); updateCanvasActions(); updateSendBtn();
}

// ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ
function renderCanvas() {
  const inner = document.getElementById('canvas-inner');
  const project = state.projects[state.activeProject]; if (!project) return;
  inner.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`;
  let html = '';
  if (project.screens.length === 0 && !state.generating) {
    html = `<div class="empty-canvas"><div class="icon">üì∏</div><div class="title">Scanner Ready</div><div>Upload a screenshot ‚Üí type "copy this" ‚Üí get pixel-perfect HTML</div></div>`;
    inner.innerHTML = html; return;
  }
  project.screens.forEach((screen, i) => {
    const dev = DEVICES[screen.device || state.device];
    const col = i % 3, row = Math.floor(i / 3);
    const x = col * (dev.w + 80), y = row * (dev.h + 100);
    const prov = PROVIDER_META[screen.provider || 'anthropic'];
    html += `<div class="screen-frame ${state.selectedScreen===i?'selected':''}" style="left:${x}px;top:${y}px;" onclick="selectScreen(${i})">
      <div class="label" style="max-width:${dev.w}px;">${esc(screen.name)} <span class="prov" style="background:${prov.color}22;color:${prov.color};">${prov.label}</span></div>
      <div class="frame" style="width:${dev.w}px;height:${dev.h}px;">
        <iframe srcdoc="${escAttr(screen.html)}" width="${dev.w}" height="${dev.h}" sandbox="allow-scripts" title="${esc(screen.name)}"></iframe>
      </div>
    </div>`;
  });
  if (state.generating) {
    const dev = DEVICES[state.device];
    const idx = project.screens.length, col = idx % 3, row = Math.floor(idx / 3);
    const x = col * (dev.w + 80), y = row * (dev.h + 100);
    const prov = PROVIDER_META[state.activeProvider];
    html += `<div class="wireframe-placeholder" style="left:${x}px;top:${y}px;">
      <div class="label" style="font-size:14px;margin-bottom:10px;"><div class="pulse-dot" style="background:${prov.color}"></div> ${prov.label} generating... ${Math.round(state.progress)}%</div>
      <div class="wireframe-box" style="width:${dev.w}px;height:${dev.h}px;">
        <svg width="${dev.w}" height="${dev.h}" viewBox="0 0 ${dev.w} ${dev.h}" style="border-radius:10px;overflow:hidden;display:block;">
          <rect width="${dev.w}" height="${dev.h}" fill="#1a1a2e" rx="8"/>
          <rect x="0" y="0" width="${dev.w}" height="${dev.h*0.07}" fill="#16213e"/>
          <rect x="${dev.w*0.03}" y="${dev.h*0.015}" width="${dev.w*0.15}" height="${dev.h*0.04}" rx="6" fill="#0f3460"/>
          <rect x="${dev.w*0.78}" y="${dev.h*0.015}" width="${dev.w*0.08}" height="${dev.h*0.04}" rx="6" fill="#0f3460"/>
          <rect x="${dev.w*0.88}" y="${dev.h*0.015}" width="${dev.w*0.08}" height="${dev.h*0.04}" rx="6" fill="#0f3460"/>
          ${[0,1,2,3].map(i => `<rect x="${dev.w*(0.03+i*0.235)}" y="${dev.h*0.1}" width="${dev.w*0.22}" height="${dev.h*0.08}" rx="8" fill="#16213e" opacity="0.8"/>`).join('')}
          <rect x="${dev.w*0.03}" y="${dev.h*0.22}" width="${dev.w*0.55}" height="${dev.h*0.55}" rx="10" fill="#16213e" opacity="0.6"/>
          <rect x="${dev.w*0.6}" y="${dev.h*0.22}" width="${dev.w*0.37}" height="${dev.h*0.55}" rx="10" fill="#16213e" opacity="0.5"/>
          ${[0,1,2,3].map(i => `<rect x="${dev.w*(0.04+i*0.13)}" y="${dev.h*0.26}" width="${dev.w*0.12}" height="${dev.h*0.12}" rx="6" fill="#0f3460" opacity="0.7"/>`).join('')}
          <rect x="${dev.w*0.62}" y="${dev.h*0.26}" width="${dev.w*0.33}" height="${dev.h*0.04}" rx="4" fill="#0f3460" opacity="0.5"/>
          <rect x="${dev.w*0.62}" y="${dev.h*0.32}" width="${dev.w*0.33}" height="${dev.h*0.04}" rx="4" fill="#0f3460" opacity="0.4"/>
          <rect x="${dev.w*0.62}" y="${dev.h*0.38}" width="${dev.w*0.33}" height="${dev.h*0.04}" rx="4" fill="#0f3460" opacity="0.4"/>
          <rect x="${dev.w*0.62}" y="${dev.h*0.6}" width="${dev.w*0.33}" height="${dev.h*0.07}" rx="8" fill="#1e3a5f" opacity="0.8"/>
          <rect x="0" y="${dev.h*0.85}" width="${dev.w}" height="${dev.h*0.15}" fill="#16213e" opacity="0.5"/>
          <rect x="0" y="${dev.h-6}" width="${dev.w*(state.progress/100)}" height="6" fill="${prov.color}" rx="3"/>
          <rect x="0" y="${dev.h*(state.progress/100)}" width="${dev.w}" height="3" fill="${prov.color}" opacity="0.5">
            <animate attributeName="opacity" values="0.5;0.15;0.5" dur="1.5s" repeatCount="indefinite"/>
          </rect>
        </svg>
      </div>
      <div class="progress-bar" style="margin-top:10px;height:6px;"><div class="fill" style="width:${state.progress}%;background:${prov.color};"></div></div>
    </div>`;
  }
  inner.innerHTML = html;
}

function selectScreen(idx) { state.selectedScreen = idx; renderCanvas(); updateCanvasActions(); }

function updateCanvasActions() {
  const project = state.projects[state.activeProject]; if (!project) return;
  document.getElementById('screenCountBadge').textContent = `${project.screens.length} screen${project.screens.length!==1?'s':''}`;
  const has = state.selectedScreen !== null && project.screens[state.selectedScreen];
  document.getElementById('previewBtn').style.display = has ? '' : 'none';
  document.getElementById('exportBtn').style.display = has ? '' : 'none';
}

async function previewSelected() {
  const s = state.projects[state.activeProject]?.screens[state.selectedScreen]; if (!s) return;
  try {
    const formData = new FormData();
    formData.append('html', s.html);
    formData.append('name', s.name);
    const resp = await fetch('/api/preview', { method: 'POST', body: formData });
    const data = await resp.json();
    window.open(data.url, '_blank');
  } catch(e) {
    // Fallback to blob URL
    const blob = new Blob([s.html], { type: 'text/html' });
    window.open(URL.createObjectURL(blob), '_blank');
  }
}
function toggleExportMenu() {
  const m = document.getElementById('exportMenu');
  m.style.display = m.style.display === 'none' ? 'block' : 'none';
}
document.addEventListener('click', (e) => {
  if (!e.target.closest('#exportWrap')) document.getElementById('exportMenu').style.display = 'none';
});

async function exportAs(format) {
  document.getElementById('exportMenu').style.display = 'none';
  const s = state.projects[state.activeProject]?.screens[state.selectedScreen];
  if (!s) return;
  const name = s.name.replace(/\s+/g, '-').toLowerCase();
  
  if (format === 'html') {
    const blob = new Blob([s.html], { type: 'text/html' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = name + '.html'; a.click();
  }
  else if (format === 'svg') {
    try {
      const formData = new FormData();
      formData.append('html', s.html);
      formData.append('name', name);
      formData.append('device', s.device || state.device);
      const resp = await fetch('/api/export/svg', { method: 'POST', body: formData });
      if (!resp.ok) throw new Error('SVG export failed');
      const blob = await resp.blob();
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = name + '.svg'; a.click();
      addChatMessage('assistant', 'üé® SVG exported ‚Äî drag into Figma to import with layers');
    } catch(e) {
      // Fallback: basic SVG with foreignObject
      const dev = DEVICES[s.device || state.device];
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${dev.w}" height="${dev.h}"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">${s.html}</div></foreignObject></svg>`;
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = name + '.svg'; a.click();
    }
  }
  else if (format === 'png') {
    try {
      const formData = new FormData();
      formData.append('html', s.html);
      formData.append('name', name);
      formData.append('device', s.device || state.device);
      const resp = await fetch('/api/export/png', { method: 'POST', body: formData });
      if (!resp.ok) throw new Error('PNG export failed');
      const blob = await resp.blob();
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = name + '.png'; a.click();
    } catch(e) {
      addChatMessage('assistant', '‚ö†Ô∏è PNG export requires server-side rendering. Try HTML export instead.');
    }
  }
}

function canvasWheel(e) { e.preventDefault(); state.zoom = Math.max(0.1, Math.min(3, state.zoom + (e.deltaY > 0 ? -0.05 : 0.05))); document.getElementById('zoomVal').textContent = Math.round(state.zoom * 100) + '%'; updateCanvasTransform(); }
function canvasMouseDown(e) { if (state.tool === 'move' || e.button === 1) { state.isPanning = true; state.panStart = { x: e.clientX - state.pan.x, y: e.clientY - state.pan.y }; document.getElementById('canvas').classList.add('panning'); } }
function canvasMouseMove(e) { if (state.isPanning) { state.pan = { x: e.clientX - state.panStart.x, y: e.clientY - state.panStart.y }; updateCanvasTransform(); } }
function canvasMouseUp() { state.isPanning = false; document.getElementById('canvas').classList.remove('panning'); }
function setTool(t) { state.tool = t; document.getElementById('toolSelect').className = t==='select'?'active':''; document.getElementById('toolMove').className = t==='move'?'active':''; document.getElementById('canvas').classList.toggle('moving', t==='move'); }
function zoomBy(d) { state.zoom = Math.max(0.1, Math.min(3, state.zoom + d)); document.getElementById('zoomVal').textContent = Math.round(state.zoom * 100) + '%'; updateCanvasTransform(); }
function resetView() { state.zoom = 0.4; state.pan = { x: 60, y: 60 }; document.getElementById('zoomVal').textContent = '40%'; updateCanvasTransform(); }
function updateCanvasTransform() { const inner = document.getElementById('canvas-inner'); if (inner) inner.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.zoom})`; }
function centerOnPlaceholder() {
  const dev = DEVICES[state.device];
  const canvasArea = document.getElementById('canvas-area');
  if (!canvasArea) return;
  const cw = canvasArea.clientWidth, ch = canvasArea.clientHeight;
  state.zoom = Math.min(0.6, (cw - 80) / dev.w, (ch - 80) / dev.h);
  state.pan = { x: (cw - dev.w * state.zoom) / 2, y: (ch - dev.h * state.zoom) / 2 };
  document.getElementById('zoomVal').textContent = Math.round(state.zoom * 100) + '%';
}

// ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
let newProjectDevice = 'tablet';
function showNewProject() { newProjectDevice = 'tablet'; document.getElementById('newProjectName').value = ''; renderDeviceOptions(); document.getElementById('newProjectModal').style.display = 'flex'; setTimeout(() => document.getElementById('newProjectName').focus(), 100); }
function closeNewProject() { document.getElementById('newProjectModal').style.display = 'none'; }
function renderDeviceOptions() { document.getElementById('deviceOptions').innerHTML = Object.entries(DEVICES).map(([k,v]) => `<button class="device-option ${newProjectDevice===k?'active':''}" onclick="newProjectDevice='${k}';renderDeviceOptions()"><div class="icon">${v.icon}</div><div class="label">${v.label}</div><div class="size">${v.w}√ó${v.h}</div></button>`).join(''); }
function createProject() {
  const name = document.getElementById('newProjectName').value.trim(); if (!name) return;
  state.projects.push({ name, device: newProjectDevice, createdAt: new Date().toISOString(), screens: [] });
  persist(); closeNewProject(); openProject(state.projects.length - 1);
}

function showSettings() {
  document.getElementById('keyAnthropic').value = state.keys.anthropic;
  document.getElementById('keyXai').value = state.keys.xai;
  document.getElementById('keyGemini').value = state.keys.gemini;
  document.getElementById('keyOpenai').value = state.keys.openai;
  document.getElementById('settingsModal').style.display = 'flex';
}
function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
function saveSettings() {
  state.keys.anthropic = document.getElementById('keyAnthropic').value.trim();
  state.keys.xai = document.getElementById('keyXai').value.trim();
  state.keys.gemini = document.getElementById('keyGemini').value.trim();
  state.keys.openai = document.getElementById('keyOpenai').value.trim();
  // Auto-select first available if current has no key
  if (!state.keys[state.activeProvider]) {
    const avail = Object.keys(state.keys).find(k => state.keys[k]);
    if (avail) state.activeProvider = avail;
  }
  persistKeys(); updateProviderBadge();
  if (state.view === 'studio') renderProviderBar();
  closeSettings();
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function escAttr(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
